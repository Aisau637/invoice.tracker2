<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Andres Invoice Tracker</title>
  <style>
    :root{
      /* Glacier blue theme */
      --bg1:#e6f2f8; --bg2:#d8eef7; --card:#ffffff; --muted:#6b7c93; --text:#0b3356; --sub:#496b89; --ok:#15803d; --warn:#b45309; --alert:#b91c1c; --accent:#4ba3d9; --line:#cfe5f2;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;color:var(--text)}
    .wrap{max-width:1200px;margin:24px auto;padding:16px}
    h1{margin:0 0 4px;font-size:28px}
    .sub{color:var(--sub);font-size:12px}
    .grid{display:grid;gap:12px}
    .g-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .g-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .g-4{grid-template-columns:repeat(4,minmax(0,1fr))}
    @media(max-width:900px){.g-2,.g-3,.g-4{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 5px 16px rgba(15,64,96,.06)}
    label{display:block;font-size:12px;color:var(--sub);margin-bottom:4px}
    input,select,button,textarea{font:inherit}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#f7fbfe;color:var(--text)}
    .row{display:flex;gap:8px;align-items:center}
    .btn{padding:10px 14px;border:1px solid var(--line);border-radius:12px;background:#eff7fc;color:var(--text);cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,#7cc7ef,#5bb6e8);border-color:#4ba3d9;color:#07324f}
    .btn.ghost{background:transparent}
      .badge{display:inline-flex;gap:6px;align-items:center;border-radius:999px;padding:6px 10px;font-size:12px;border:1px solid var(--line);background:#eef7fd;color:var(--sub)}
    .badge.ok{background:#e8f6ee;border-color:#bde7cd;color:#0f5132}
    .badge.warn{background:#fff6e6;border-color:#f3d9aa;color:#7a4a0b}
    .badge.alert{background:#ffebeb;border-color:#f0b5b5;color:#7f1d1d}
    .stat{border:1px solid var(--line);border-radius:16px;padding:12px;background:#ffffff}
    .stat .l{font-size:11px;color:var(--sub);text-transform:uppercase;letter-spacing:.08em}
    .stat .v{font-size:22px;font-weight:700}
    .muted{color:var(--sub)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
    th{color:var(--sub);font-weight:600;background:#f5fbff}
    .right{text-align:right}
    .footer{color:#587795;text-align:center;padding:16px;font-size:12px}
    .pill{padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#eef7fd;color:#0b3356;font-size:12px}
    .progress{height:10px;background:#eef7fd;border:1px solid var(--line);border-radius:999px;overflow:hidden}
    .progress > b{display:block;height:100%;background:linear-gradient(90deg,#22c55e,#16a34a)}
    .tabs{display:flex;gap:8px;margin:12px 0;flex-wrap:wrap}
    .tab{padding:8px 12px;border-radius:999px;border:1px solid var(--line);background:#eef7fd;color:#0b3356;cursor:pointer}
    .tab.active{background:#5bb6e8;color:#03263e;border-color:#4ba3d9}
    .svgwrap{display:grid;place-items:center}
      .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="row" style="justify-content:space-between;align-items:flex-end">
      <div>
        <h1>Andres Invoice Tracker</h1>
        <div class="sub">Liquor • Beer • Wine — month-by-month tracking with year summary. Data saves locally.</div>
      </div>
      <div class="row" style="gap:16px;align-items:center">
        <div class="row" style="gap:6px">
          <label for="monthPick" style="margin:0">Month</label>
          <input type="month" id="monthPick" />
          <button class="btn" id="prevMonth">◀</button>
          <button class="btn" id="nextMonth">▶</button>
        </div>
        <div style="min-width:240px">
          <label for="userPick" style="margin:0">User</label>
          <div class="row" style="gap:8px">
            <select id="userPick"></select>
          </div>
        </div>
      </div>
    </header>

    <nav class="tabs">
      <button class="tab active" data-tab="dash">Dashboard</button>
      <button class="tab" data-tab="sales">Sales (Daily)</button>
      <button class="tab" data-tab="liq">Liquor</button>
      <button class="tab" data-tab="beer">Beer</button>
      <button class="tab" data-tab="wine">Wine</button>
      <button class="tab" data-tab="inv">Invoices</button>
      <button class="tab" data-tab="year">Year Summary</button>
      <button class="tab" data-tab="users">Users</button>
      <button class="tab" data-tab="settings">Settings</button>
    </nav>

    <!-- DASHBOARD (Totals only) -->
    <section id="dash" class="grid g-2">
      <div class="card">
        <div class="grid g-2">
          <div>
            <label>Start Date</label>
            <input type="date" id="startDate"/>
          </div>
          <div>
            <label>End Date</label>
            <input type="date" id="endDate"/>
          </div>
        </div>

        <div class="grid g-3" style="margin-top:12px">
          <div class="stat"><div class="l">Total Sales</div><div class="v" id="totalSales">$0.00</div></div>
          <div class="stat"><div class="l">Total Purchases</div><div class="v" id="totalPurch">$0.00</div></div>
          <div class="stat"><div class="l">Budget Remaining (Total)</div><div class="v" id="budRemain">$0.00</div></div>
        </div>

        <div class="grid g-2" style="margin-top:12px">
          <div class="card">
            <div class="row" style="justify-content:space-between;margin-bottom:8px">
              <b>Overall COGS</b>
              <span id="overallBadge" class="badge">—</span>
            </div>
            <div class="svgwrap" style="height:260px">
              <svg id="gauge" width="240" height="240" viewBox="0 0 240 240"></svg>
            </div>
            <div class="sub" id="overallText">$0 / $0 = 0.00%</div>
          </div>
          <div class="card">
            <b>Spend Guidance (Total)</b>
            <div class="muted" style="margin-top:8px">Max Spend @ 21%: <b id="max21">$0.00</b></div>
            <div class="muted" style="margin-top:4px">Remaining to stay @ 21%: <b id="remain21">$0.00</b></div>
            <div style="margin-top:12px" class="row">
              <button class="btn ghost" id="resetAll" style="color:#b91c1c">Reset All Data</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <b>Quick Add Invoice</b>
        <div class="grid g-2" style="margin-top:8px">
          <div>
            <label>Date</label>
            <input type="date" id="invDate"/>
          </div>
          <div>
            <label>Category</label>
            <select id="invCat">
              <option>Liquor</option>
              <option>Beer</option>
              <option>Wine</option>
            </select>
          </div>
        </div>
        <div class="grid g-2" style="margin-top:8px">
          <div>
            <label>Vendor</label>
            <input id="invVendor" placeholder="Republic, Ben E. Keith, etc."/>
          </div>
          <div>
            <label>Invoice #</label>
            <input id="invNo"/>
          </div>
        </div>
        <div style="margin-top:8px">
          <label>Description</label>
          <input id="invDesc" placeholder="e.g., Patron 1L x 6"/>
        </div>
        <div style="margin-top:8px">
          <label>Amount</label>
          <input type="number" id="invAmt" placeholder="0"/>
        </div>
        <div style="margin-top:12px" class="row">
          <button class="btn primary" id="addInv">Add Invoice</button>
        </div>
      </div>
    </section>

    <!-- SALES (DAILY) -->
    <section id="sales" class="card" style="display:none">
      <div class="row" style="justify-content:space-between">
        <b>Daily Sales for <span id="salesMonthLabel"></span></b>
        <span class="pill" id="salesTotals">Liquor $0 • Beer $0 • Wine $0</span>
      </div>
      <div style="overflow:auto;margin-top:8px">
        <table>
          <thead>
            <tr>
              <th>Date</th><th>Liquor</th><th>Beer</th><th>Wine</th><th class="right">Total</th>
            </tr>
          </thead>
          <tbody id="salesTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- CATEGORY TABS -->
    <section id="liq" class="card" style="display:none"></section>
    <section id="beer" class="card" style="display:none"></section>
    <section id="wine" class="card" style="display:none"></section>

    <!-- INVOICES -->
    <section id="inv" class="card" style="display:none">
      <div class="row" style="justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
        <b>Invoices (filtered by date range)</b>
        <div class="row" style="gap:8px;align-items:center">
          <label for="filterUser" style="margin:0" class="sub">Filter by user</label>
          <select id="filterUser"></select>
          <span class="pill" id="invCount">0 items</span>
        </div>
      </div>
      <div style="overflow:auto;margin-top:8px">
        <table>
          <thead>
            <tr>
              <th>Date</th><th>Category</th><th>Vendor</th><th>Invoice #</th><th>Description</th><th class="right">Amount</th><th>Added By</th><th class="right">Actions</th>
            </tr>
          </thead>
          <tbody id="invTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- YEAR SUMMARY -->
    <section id="year" class="card" style="display:none">
      <div class="row" style="justify-content:space-between">
        <b>Year Summary — <span id="yearLabel"></span></b>
        <span class="sub">Aggregates saved months for this year</span>
      </div>
      <div style="overflow:auto;margin-top:8px">
        <table>
          <thead>
            <tr>
              <th>Month</th>
              <th class="right">Sales</th>
              <th class="right">Purchases</th>
              <th class="right">COGS%</th>
              <th class="right">Under 21% Days</th>
              <th class="right">Over 22% Days</th>
            </tr>
          </thead>
          <tbody id="yearTbody"></tbody>
          <tfoot>
            <tr>
              <th>Total</th>
              <th class="right" id="yrSales">$0</th>
              <th class="right" id="yrPurch">$0</th>
              <th class="right" id="yrCOGS">0.00%</th>
              <th class="right" id="yrUnder">0</th>
              <th class="right" id="yrOver">0</th>
            </tr>
          </tfoot>
        </table>
      </div>
    </section>

    <!-- USERS (Admin only) -->
    <section id="users" class="card" style="display:none">
      <div class="row" style="justify-content:space-between;align-items:center">
        <b>Users</b>
        <div class="row" style="gap:8px;align-items:center">
          <span class="sub">Admin only</span>
          <button class="btn" id="newUserBtn">New User</button>
        </div>
      </div>
      <div style="overflow:auto;margin-top:8px">
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Role</th>
              <th>Status</th>
              <th class="right">Actions</th>
            </tr>
          </thead>
          <tbody id="usersTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="settings" class="card" style="display:none">
      <b>Data Export / Import</b>
      <div class="sub" style="margin-top:6px">Stored per month. Copy or import your JSON snapshot.</div>
      <div style="margin-top:8px">
        <textarea id="dataText" style="width:100%;height:180px"></textarea>
      </div>
      <div class="row" style="margin-top:8px;gap:8px">
        <button class="btn" id="copyData">Copy JSON</button>
        <button class="btn ghost" id="importData">Import JSON</button>
      </div>
    </section>

    <div class="footer">COGS Quest — keep it ≤ 21% and win the month.</div>
  </div>

  <!-- Confirm Invoice Modal -->
  <div id="confirmModal" class="modal">
    <div class="card" style="max-width:560px;width:100%">
      <b>Confirm Invoice</b>
      <div id="confirmBody" class="muted" style="margin-top:8px"></div>
      <div class="row" style="justify-content:flex-end;margin-top:12px;gap:8px">
        <button class="btn" id="editInv">Edit</button>
        <button class="btn primary" id="confirmInv">Confirm & Save</button>
      </div>
    </div>
  </div>

<script>
(function(){
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));
  const fmt = (n) => (n||0).toLocaleString(undefined,{style:'currency',currency:'USD'});
  const todayStr = () => new Date().toISOString().slice(0,10);
  const ymStr = (d)=> d.toISOString().slice(0,7); // YYYY-MM
  const firstOfMonth = (d=new Date()) => new Date(d.getFullYear(), d.getMonth(), 1);
  const daysInMonth = (y,m)=> new Date(y, m+1, 0).getDate();
  const uid = () => Math.random().toString(36).slice(2);

  const STORE_KEY = 'cogs-glacier-v3';

  // Structure: { selectedYM, months: { 'YYYY-MM': MonthData }, users:[{id,name,active}], activeUserId }
  const defaultMonth = (y,m)=>({
    invoices: [],
    budgets: { Liquor:0, Beer:0, Wine:0 },
    salesDaily: {}, // 'YYYY-MM-DD': { Liquor, Beer, Wine }
  });

  function load(){
    try{ return JSON.parse(localStorage.getItem(STORE_KEY)||'') || {}; }catch{ return {}; }
  }
  function save(){ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }

  // init state
  let state = load();
  if(!state.selectedYM){ state.selectedYM = ymStr(new Date()); }
  if(!state.months){ state.months = {}; }
  if(!state.users){ state.users = []; }
  if(!state.activeUserId){
    if(state.users.length===0){ const id=uid(); state.users.push({id, name:'Admin', active:true, isAdmin:true}); state.activeUserId = id; }
    else { state.activeUserId = state.users[0].id; }
  }
  if(!state.months[state.selectedYM]){
    const d = new Date(state.selectedYM+'-01T00:00:00');
    state.months[state.selectedYM] = defaultMonth(d.getFullYear(), d.getMonth());
  }
  migrateState();
  save();

  // DOM init
  $('#monthPick').value = state.selectedYM;
  $('#invDate').value = todayStr();
  populateUsers();
  populateFilterUsers();
  updateAdminUI();
  let lastActiveUserId = state.activeUserId;
  $('#userPick').addEventListener('change', async (e)=>{
    const newId = e.target.value || null;
    const ok = await handleUserSwitch(newId);
    if(!ok){ $('#userPick').value = lastActiveUserId || ''; return; }
    lastActiveUserId = newId; updateAdminUI();
  });
  $('#filterUser').addEventListener('change', ()=>{ render(); });

  // Tabs
  $$('.tab').forEach(btn=>btn.addEventListener('click',()=>{
    $$('.tab').forEach(x=>x.classList.remove('active'));
    btn.classList.add('active');
    const t = btn.dataset.tab;
    ['dash','sales','liq','beer','wine','inv','year','users','settings'].forEach(id=>$('#'+id).style.display = (id===t? (t==='dash'?'grid':'block') : 'none'));
    if(t==='settings'){ $('#dataText').value = JSON.stringify(state,null,2); }
    if(t==='sales'){ renderSalesTable(); }
    if(t==='year'){ renderYear(); }
    if(t==='users'){ renderUsersPage(); }
    if(['liq','beer','wine'].includes(t)) renderCategory(t);
    updateAdminUI();
  }));

  // Month picker prev/next
  $('#prevMonth').addEventListener('click',()=>changeMonth(-1));
  $('#nextMonth').addEventListener('click',()=>changeMonth(1));
  $('#monthPick').addEventListener('change',(e)=>{ setMonth(e.target.value); });

  function setMonth(ym){
    state.selectedYM = ym;
    if(!state.months[ym]) state.months[ym] = defaultMonth(...ym.split('-').map(Number));
    save();
    render();
    renderSalesTable();
    renderCategory('liq');
  }
  function changeMonth(delta){
    const [y,m] = state.selectedYM.split('-').map(Number);
    const d = new Date(y, m-1+delta, 1);
    const ym = ymStr(d);
    setMonth(ym);
    $('#monthPick').value = ym;
  }

  // Quick add invoice
  let pendingInv = null;
  $('#addInv').addEventListener('click', ()=>{
    const inv = {
      id: uid(),
      date: $('#invDate').value,
      category: $('#invCat').value,
      vendor: $('#invVendor').value.trim(),
      invoiceNo: $('#invNo').value.trim(),
      description: $('#invDesc').value.trim(),
      amount: +$('#invAmt').value||0,
      addedBy: state.activeUserId || null,
      addedByName: userName(state.activeUserId) || null
    };
    if(!inv.date || !inv.amount) { alert('Enter at least a date and amount'); return; }
    pendingInv = inv;
    showConfirm(inv);
  });

  // Date filters
  $('#startDate').addEventListener('change', ()=> render());
  $('#endDate').addEventListener('change', ()=> render());

  // Settings
  $('#copyData').addEventListener('click',()=>{
    const me = (state.users||[]).find(u=>u.id===state.activeUserId);
    if(!me || !me.isAdmin){ alert('Only admin can export JSON.'); return; }
    navigator.clipboard.writeText(JSON.stringify(state)); alert('Data copied');
  });
  $('#importData').addEventListener('click',()=>{
    try{
      const obj = JSON.parse($('#dataText').value);
      state = obj || {};
      if(!state.selectedYM) state.selectedYM = ymStr(new Date());
      if(!state.months) state.months = {};
      if(!state.users || !Array.isArray(state.users) || state.users.length===0){
        const id = uid(); state.users = [{id, name:'Admin', active:true}]; state.activeUserId = id;
      }
      // ensure active flag on users
      state.users = state.users.map(u=> ({ id:u.id||uid(), name:u.name||'User', active: (u.active!==false) }));
      migrateState();
      if(!state.activeUserId) state.activeUserId = state.users[0].id;
      save();
      populateUsers();
      populateFilterUsers();
      render(); renderSalesTable(); renderCategory('liq'); alert('Imported!');
    }catch{ alert('Invalid JSON'); }
  });

  // Reset all data
  $('#resetAll').addEventListener('click', ()=>{
    const me = (state.users||[]).find(u=>u.id===state.activeUserId);
    if(!me || !me.isAdmin){ alert('Only admin can reset all data.'); return; }
    if(confirm('This will delete all saved data for this app on this device. Continue?')){
      try{ localStorage.removeItem(STORE_KEY); }catch{}
      location.reload();
    }
  });

  function monthMeta(ym){
    const mm = state.months[ym];
    // sum daily sales
    let sL=0,sB=0,sW=0; Object.values(mm.salesDaily).forEach(v=>{ sL+=v.Liquor||0; sB+=v.Beer||0; sW+=v.Wine||0; });
    const sales = {Liquor:sL, Beer:sB, Wine:sW};
    // date range defaults
    const d = new Date(ym+'-01T00:00:00');
    const start = $('#startDate').value || new Date(d.getFullYear(), d.getMonth(), 1).toISOString().slice(0,10);
    const end = $('#endDate').value || new Date(d.getFullYear(), d.getMonth()+1, 0).toISOString().slice(0,10);

    // filter invoices by range
    const inv = mm.invoices.filter(i=>{ const t=i.date; return t>=start && t<=end; });
    const purch = {Liquor:0, Beer:0, Wine:0}; inv.forEach(i=> purch[i.category]+= i.amount||0);

    const totals = {
      salesTotal: sales.Liquor + sales.Beer + sales.Wine,
      purchTotal: purch.Liquor + purch.Beer + purch.Wine,
      budgetTotal: mm.budgets.Liquor + mm.budgets.Beer + mm.budgets.Wine
    };

    const cogs = {
      Liquor: sales.Liquor ? purch.Liquor/sales.Liquor : 0,
      Beer: sales.Beer ? purch.Beer/sales.Beer : 0,
      Wine: sales.Wine ? purch.Wine/sales.Wine : 0,
    };

    const overall = totals.salesTotal ? totals.purchTotal / totals.salesTotal : 0;

    return { mm, sales, inv, purch, totals, cogs, overall, start, end };
  }

  function render(){
    const ym = state.selectedYM;
    const { mm, inv, totals, overall } = monthMeta(ym);

    // Stats (totals only)
    $('#totalSales').textContent = fmt(totals.salesTotal);
    $('#totalPurch').textContent = fmt(totals.purchTotal);
    $('#budRemain').textContent = fmt(totals.budgetTotal - totals.purchTotal);

    const badge = $('#overallBadge');
    const status = overall>0.22? 'alert' : overall>0.21? 'warn' : 'ok';
    badge.className = 'badge '+status;
    badge.textContent = status==='alert'? 'Over 22%' : status==='warn'? '> 21%' : 'On Target';

    $('#overallText').textContent = `${fmt(totals.purchTotal)} / ${fmt(totals.salesTotal)} = ${(overall*100).toFixed(2)}%`;
    $('#max21').textContent = fmt(0.21*totals.salesTotal);
    $('#remain21').textContent = fmt(0.21*totals.salesTotal - totals.purchTotal);

    // Render invoices table
    const me = (state.users||[]).find(u=>u.id===state.activeUserId);
    const isAdmin = !!(me && me.isAdmin);
    const tbody = $('#invTbody');
    tbody.innerHTML = '';
    let list = inv;
    const filterSel = $('#filterUser');
    const filterVal = filterSel ? filterSel.value : 'ALL';
    if(filterVal && filterVal !== 'ALL'){
      list = inv.filter(i=> (i.addedBy===filterVal) || (i.addedByName && i.addedByName===userName(filterVal)) );
    }
    list.forEach(one=>{
      const tr = document.createElement('tr');
      const delBtn = isAdmin ? `<button class=\"btn ghost\" data-del=\"${one.id}\">Delete</button>` : '';
      tr.innerHTML = `<td>${one.date}</td><td>${one.category}</td><td>${esc(one.vendor)}</td><td>${esc(one.invoiceNo)}</td><td>${esc(one.description)}</td><td class=\"right\">${fmt(one.amount)}</td><td>${one.addedByName || userName(one.addedBy) || '—'}</td><td class=\"right\">${delBtn}</td>`;
      tbody.appendChild(tr);
    });
    const count = list.length;
    $('#invCount').textContent = count + ' item' + (count===1?'':'s');

    $$('button[data-del]').forEach(btn=>btn.addEventListener('click',()=>{
      const meNow = (state.users||[]).find(u=>u.id===state.activeUserId);
      if(!meNow || !meNow.isAdmin){ alert('Only admin can delete invoices.'); return; }
      const id = btn.getAttribute('data-del');
      const ym = state.selectedYM;
      const mm = state.months[ym];
      mm.invoices = mm.invoices.filter(x=>x.id!==id); save(); render();
    }));

    // Gauge
    drawGauge(overall*100);
  }

  function populateUsers(){
    const sel = $('#userPick');
    if(!sel) return;
    sel.innerHTML = '';
    state.users.filter(u=>u.active!==false).forEach(u=>{
      const opt = document.createElement('option');
      opt.value = u.id; opt.textContent = `${u.name}${u.isAdmin?' (admin)':''}`; if(state.activeUserId===u.id) opt.selected = true; sel.appendChild(opt);
    });
  }

  function userName(id){
    if(!id) return null;
    const u = (state.users||[]).find(x=>x.id===id);
    return u? u.name : null;
  }

  function populateFilterUsers(){
    const sel = $('#filterUser');
    if(!sel) return;
    sel.innerHTML = '';
    const optAll = document.createElement('option');
    optAll.value = 'ALL'; optAll.textContent = 'All Users'; sel.appendChild(optAll);
    state.users.forEach(u=>{
      const opt = document.createElement('option');
      opt.value = u.id; opt.textContent = `${u.name}${(u.active===false)?' (inactive)':''}`; sel.appendChild(opt);
    });
    sel.value = 'ALL';
  }

  function showConfirm(inv){
    const el = $('#confirmBody');
    el.innerHTML = `
      <div class="grid g-2">
        <div><div class="sub">Date</div><div><b>${inv.date}</b></div></div>
        <div><div class="sub">Category</div><div><b>${inv.category}</b></div></div>
        <div><div class="sub">Vendor</div><div>${esc(inv.vendor)||'—'}</div></div>
        <div><div class="sub">Invoice #</div><div>${esc(inv.invoiceNo)||'—'}</div></div>
        <div style="grid-column:1/-1"><div class="sub">Description</div><div>${esc(inv.description)||'—'}</div></div>
        <div><div class="sub">Amount</div><div><b>${fmt(inv.amount)}</b></div></div>
        <div><div class="sub">Added By</div><div>${inv.addedByName || userName(inv.addedBy) || '—'}</div></div>
      </div>`;
    $('#confirmModal').style.display = 'flex';
  }

  function hideConfirm(){ $('#confirmModal').style.display = 'none'; }

  $('#confirmInv').addEventListener('click', ()=>{
    if(!pendingInv) { hideConfirm(); return; }
    const inv = pendingInv; pendingInv = null;
    const ym = inv.date.slice(0,7);
    if(!state.months[ym]) state.months[ym] = defaultMonth(...ym.split('-').map(Number));
    state.months[ym].invoices.unshift(inv);
    save();
    // clear form except date/category
    $('#invVendor').value = ''; $('#invNo').value=''; $('#invDesc').value=''; $('#invAmt').value='';
    hideConfirm();
    render();
  });

  $('#editInv').addEventListener('click', ()=>{ pendingInv = null; hideConfirm(); });

  function renderSalesTable(){
    const ym = state.selectedYM; const mm = state.months[ym];
    const [Y,M] = ym.split('-').map(Number); const days = daysInMonth(Y,M-1);
    $('#salesMonthLabel').textContent = ym;
    const tbody = $('#salesTbody'); tbody.innerHTML='';

    for(let d=1; d<=days; d++){
      const date = new Date(Y, M-1, d).toISOString().slice(0,10);
      const row = mm.salesDaily[date] || {Liquor:0,Beer:0,Wine:0};
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${date}</td>
        <td><input type="number" class="sale" data-s="L" data-date="${date}" value="${row.Liquor||0}"/></td>
        <td><input type="number" class="sale" data-s="B" data-date="${date}" value="${row.Beer||0}"/></td>
        <td><input type="number" class="sale" data-s="W" data-date="${date}" value="${row.Wine||0}"/></td>
        <td class="right" data-total="${date}">${fmt((row.Liquor||0)+(row.Beer||0)+(row.Wine||0))}</td>`;
      tbody.appendChild(tr);
    }

    // helper: live total update from inputs in DOM (no save)
    const recalcRowTotal = (date)=>{
      const inputs = $$(`input.sale[data-date="${date}"]`);
      const v = inputs.reduce((acc,el)=>acc + (+el.value||0),0);
      const cell = $(`td[data-total="${date}"]`);
      if(cell) cell.textContent = fmt(v);
    };
    const recalcTotalsPill = ()=>{
      let tL=0,tB=0,tW=0;
      $$('#salesTbody input.sale').forEach(el=>{
        const val = +el.value||0; const k = el.getAttribute('data-s');
        if(k==='L') tL+=val; else if(k==='B') tB+=val; else tW+=val;
      });
      $('#salesTotals').textContent = `Liquor ${fmt(tL)} • Beer ${fmt(tB)} • Wine ${fmt(tW)}`;
    };

    // bind inputs — type freely; save on blur/change/Enter only
    $$('#salesTbody input.sale').forEach(inp=>{
      const date = inp.getAttribute('data-date');
      // 1) Live feedback while typing
      inp.addEventListener('input', ()=>{ recalcRowTotal(date); recalcTotalsPill(); });
      // 2) Commit on blur/change
      const commit = ()=>{
        if(!mm.salesDaily[date]) mm.salesDaily[date] = {Liquor:0,Beer:0,Wine:0};
        const map = {L:'Liquor', B:'Beer', W:'Wine'}; const k = map[inp.getAttribute('data-s')];
        mm.salesDaily[date][k] = +inp.value||0;
        save();
        // update dashboard numbers without rebuilding this table
        render();
      };
      inp.addEventListener('change', commit);
      inp.addEventListener('blur', commit);
      inp.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ inp.blur(); } });
    });

    // initial totals pill from DOM
    recalcTotalsPill();
  }

  function renderCategory(which){
    const map = { liq:'Liquor', beer:'Beer', wine:'Wine' };
    const cat = map[which];
    const ym = state.selectedYM; const { mm, sales, inv, purch } = monthMeta(ym);
    const salesCat = sales[cat];
    const purchCat = purch[cat];
    const cogsCat = salesCat ? (purchCat / salesCat) : 0;
    const remain21Cat = 0.21 * salesCat - purchCat;

    // Build invoices list for this category
    const invCat = inv.filter(i=>i.category===cat);

    const el = document.getElementById(which);
    el.innerHTML = `
      <div class="row" style="justify-content:space-between;align-items:center">
        <b>${cat} — Details</b>
        <span class="pill">${invCat.length} invoice${invCat.length===1?'':'s'}</span>
      </div>
      <div class="grid g-3" style="margin-top:12px">
        <div class="stat"><div class="l">${cat} Sales</div><div class="v">${fmt(salesCat)}</div></div>
        <div class="stat"><div class="l">${cat} Purchases</div><div class="v">${fmt(purchCat)}</div></div>
        <div class="stat"><div class="l">${cat} COGS</div><div class="v">${(cogsCat*100).toFixed(2)}%</div></div>
      </div>
      <div class="grid g-2" style="margin-top:12px">
        <div class="card">
          <b>${cat} Spend Guidance</b>
          <div class="muted" style="margin-top:8px">Max Spend @ 21%: <b>${fmt(0.21 * salesCat)}</b></div>
          <div class="muted" style="margin-top:4px">Remaining to stay @ 21%: <b>${fmt(remain21Cat)}</b></div>
        </div>
        <div class="card">
          <b>${cat} Budget</b>
          <div class="row" style="gap:8px;align-items:center;margin-top:8px">
            <label style="margin:0">Monthly Budget</label>
            <input type="number" id="budCat" value="${mm.budgets[cat]||0}"/>
            <button class="btn" id="saveBud">Save</button>
          </div>
        </div>
      </div>
      <div style="overflow:auto;margin-top:12px">
        <table>
           <thead><tr><th>Date</th><th>Vendor</th><th>Invoice #</th><th>Description</th><th class="right">Amount</th><th>Added By</th></tr></thead>
          <tbody id="tbCat">
            ${invCat.map(x=>`<tr><td>${x.date}</td><td>${esc(x.vendor)}</td><td>${esc(x.invoiceNo)}</td><td>${esc(x.description)}</td><td class="right">${fmt(x.amount)}</td><td>${userName(x.addedBy)||'—'}</td></tr>`).join('')}
          </tbody>
        </table>
      </div>`;

    // bind save budget
    el.querySelector('#saveBud').addEventListener('click',()=>{
      const val = +el.querySelector('#budCat').value||0;
      mm.budgets[cat] = val; save(); render(); renderCategory(which);
    });
  }

  function renderYear(){
    const ym = state.selectedYM; const [Y] = ym.split('-').map(Number);
    $('#yearLabel').textContent = Y;
    const tbody = $('#yearTbody'); tbody.innerHTML='';
    let sumSales=0,sumPurch=0,sumUnder=0,sumOver=0;
    for(let m=0;m<12;m++){
      const thisYM = `${Y}-${String(m+1).padStart(2,'0')}`;
      const md = state.months[thisYM] || defaultMonth(Y,m);
      // compute daily sales totals
      let sL=0,sB=0,sW=0; Object.values(md.salesDaily).forEach(v=>{ sL+=v.Liquor||0; sB+=v.Beer||0; sW+=v.Wine||0; });
      const salesTotal = sL+sB+sW;
      const purchTotal = (md.invoices||[]).reduce((acc,i)=>acc+i.amount,0);
      const cogs = salesTotal? purchTotal/salesTotal : 0;

      // daily counts estimated from monthly ratio
      let under=0, over=0; const days = daysInMonth(Y,m);
      for(let d=1; d<=days; d++){
        const date = new Date(Y,m,d).toISOString().slice(0,10);
        const s = md.salesDaily[date] || {Liquor:0,Beer:0,Wine:0};
        const daySales = (s.Liquor||0)+(s.Beer||0)+(s.Wine||0);
        if(daySales>0){ if(cogs<=0.21) under++; else if(cogs>0.22) over++; }
      }

      sumSales+=salesTotal; sumPurch+=purchTotal; sumUnder+=under; sumOver+=over;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${thisYM}</td>
        <td class="right">${fmt(salesTotal)}</td>
        <td class="right">${fmt(purchTotal)}</td>
        <td class="right">${(cogs*100).toFixed(2)}%</td>
        <td class="right">${under}</td>
        <td class="right">${over}</td>`;
      tbody.appendChild(tr);
    }
    $('#yrSales').textContent = fmt(sumSales);
    $('#yrPurch').textContent = fmt(sumPurch);
    const yrCOGS = sumSales? (sumPurch/sumSales) : 0;
    $('#yrCOGS').textContent = (yrCOGS*100).toFixed(2)+'%';
    $('#yrUnder').textContent = sumUnder; $('#yrOver').textContent = sumOver;
  }

  function drawGauge(value){
    const svg = $('#gauge');
    svg.innerHTML = '';
    const cx=120, cy=120, r=90, stroke=18;
    const mkArc = (start, end, color)=>{
      const a0 = (start-90)*Math.PI/180, a1=(end-90)*Math.PI/180;
      const x0 = cx + r*Math.cos(a0), y0 = cy + r*Math.sin(a0);
      const x1 = cx + r*Math.cos(a1), y1 = cy + r*Math.sin(a1);
      const large = end-start>180?1:0;
      const d = `M ${x0} ${y0} A ${r} ${r} 0 ${large} 1 ${x1} ${y1}`;
      const path = document.createElementNS('http://www.w3.org/2000/svg','path');
      path.setAttribute('d', d);
      path.setAttribute('fill','none');
      path.setAttribute('stroke', color);
      path.setAttribute('stroke-width', stroke);
      path.setAttribute('stroke-linecap','round');
      return path;
    };
    // background ring
    svg.appendChild(mkArc(0,360,'#eef7fd'));
    // 21% target ring
    svg.appendChild(mkArc(0, (21/100)*360, '#cfe5f2'));
    // 22% alert ring
    svg.appendChild(mkArc(0, (22/100)*360, '#f0b5b5'));
    // value ring
    const ang = Math.max(0, Math.min(100, value))/100*360;
    const color = value>22? '#b91c1c' : value>21? '#b45309' : '#15803d';
    svg.appendChild(mkArc(0, ang, color));

    // center label
    const txt = document.createElementNS('http://www.w3.org/2000/svg','text');
    txt.setAttribute('x', cx); txt.setAttribute('y', cy+6); txt.setAttribute('text-anchor','middle'); txt.setAttribute('font-size','28'); txt.setAttribute('fill','#0b3356');
    txt.textContent = value.toFixed(2)+'%';
    svg.appendChild(txt);
  }

  function esc(s){ return (s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

  function migrateState(){
    // Ensure users array has active flag
    if(!state.users) state.users = [];
    state.users = state.users.map(u=> ({ id: u.id || uid(), name: u.name || 'User', active: (u.active!==false), isAdmin: !!u.isAdmin }));
    // Ensure there is at least one admin
    if(!state.users.some(u=>u.isAdmin)){
      const first = state.users[0]; if(first) first.isAdmin = true;
    }
    if(!state.activeUserId){
      const firstActive = state.users.find(u=>u.active!==false) || state.users[0];
      state.activeUserId = firstActive? firstActive.id : null;
    }
    // Backfill addedByName for invoices
    Object.values(state.months||{}).forEach(m=>{
      (m.invoices||[]).forEach(inv=>{
        if(inv && !inv.addedByName && (inv.addedBy || inv.addedBy===null)){
          inv.addedByName = userName(inv.addedBy) || inv.addedByName || null;
        }
      });
    });
  }

  function updateAdminUI(){
    const me = (state.users||[]).find(u=>u.id===state.activeUserId);
    const isAdmin = !!(me && me.isAdmin);
    // Hide delete buttons column header text stays, buttons are conditional in render()
    // Control access to Settings export/import/reset is additionally checked in handlers
    const delUserBtn = $('#deleteUser');
    if(delUserBtn) delUserBtn.disabled = !isAdmin;
    const renameUserBtn = $('#renameUser');
    if(renameUserBtn) renameUserBtn.disabled = !isAdmin; // optional: allow non-admin rename self; keeping simple
    const copyBtn = $('#copyData'); if(copyBtn) copyBtn.disabled = !isAdmin;
    const importBtn = $('#importData'); if(importBtn) importBtn.disabled = !isAdmin;
    const resetBtn = $('#resetAll'); if(resetBtn) resetBtn.disabled = !isAdmin;
    // Gate Users tab visibility
    const usersTab = $(`.tab[data-tab="users"]`);
    if(usersTab){ usersTab.style.display = isAdmin? 'inline-flex' : 'none'; }
    const usersSection = $('#users');
    if(usersSection && !isAdmin && usersSection.style.display!=='none'){
      // If non-admin somehow on users page, redirect to dashboard
      ['dash','sales','liq','beer','wine','inv','year','users','settings'].forEach(id=>$('#'+id).style.display = (id==='dash'? 'grid':'none'));
    }
    // Gate Settings (JSON) tab visibility
    const settingsTab = $(`.tab[data-tab="settings"]`);
    if(settingsTab){ settingsTab.style.display = isAdmin? 'inline-flex' : 'none'; }
    const settingsSection = $('#settings');
    if(settingsSection && !isAdmin && settingsSection.style.display!=='none'){
      ['dash','sales','liq','beer','wine','inv','year','users','settings'].forEach(id=>$('#'+id).style.display = (id==='dash'? 'grid':'none'));
    }
  }

  async function handleUserSwitch(newUserId){
    const target = (state.users||[]).find(u=>u.id===newUserId);
    if(!target){ state.activeUserId = newUserId; save(); return true; }
    // If switching to admin, enforce password
    if(target.isAdmin){
      // If no admin password set, prompt to create
      if(!state.adminAuth || !state.adminAuth.hash || !state.adminAuth.salt){
        const pw1 = prompt('Create admin password');
        if(!pw1){ return false; }
        const pw2 = prompt('Confirm admin password');
        if(pw1 !== pw2){ alert('Passwords do not match.'); return false; }
        const {salt, hash} = await hashPassword(pw1);
        state.adminAuth = {salt, hash}; save();
      } else {
        const pw = prompt('Enter admin password');
        if(!pw){ return false; }
        const ok = await verifyPassword(pw, state.adminAuth.salt, state.adminAuth.hash);
        if(!ok){ alert('Incorrect password'); return false; }
      }
    }
    state.activeUserId = newUserId; save();
    return true;
  }

  async function hashPassword(password){
    const enc = new TextEncoder();
    const saltBytes = crypto.getRandomValues(new Uint8Array(16));
    const keyMaterial = await window.crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveBits', 'deriveKey']);
    const key = await window.crypto.subtle.deriveKey({name:'PBKDF2', salt: saltBytes, iterations: 100000, hash:'SHA-256'}, keyMaterial, {name:'AES-GCM', length:256}, true, ['encrypt','decrypt']);
    const raw = await window.crypto.subtle.exportKey('raw', key);
    const hashArray = new Uint8Array(raw);
    const saltHex = Array.from(saltBytes).map(b=>b.toString(16).padStart(2,'0')).join('');
    const hashHex = Array.from(hashArray).map(b=>b.toString(16).padStart(2,'0')).join('');
    return { salt: saltHex, hash: hashHex };
  }

  async function verifyPassword(password, saltHex, hashHex){
    const enc = new TextEncoder();
    const saltBytes = new Uint8Array(saltHex.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
    const keyMaterial = await window.crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveBits', 'deriveKey']);
    const key = await window.crypto.subtle.deriveKey({name:'PBKDF2', salt: saltBytes, iterations: 100000, hash:'SHA-256'}, keyMaterial, {name:'AES-GCM', length:256}, true, ['encrypt','decrypt']);
    const raw = await window.crypto.subtle.exportKey('raw', key);
    const hashArray = new Uint8Array(raw);
    const calcHex = Array.from(hashArray).map(b=>b.toString(16).padStart(2,'0')).join('');
    return calcHex === hashHex;
  }

  function renderUsersPage(){
    const me = (state.users||[]).find(u=>u.id===state.activeUserId);
    if(!me || !me.isAdmin){ return; }
    const tbody = $('#usersTbody');
    if(!tbody) return;
    tbody.innerHTML='';
    const newUserBtn = $('#newUserBtn');
    if(newUserBtn){
      newUserBtn.onclick = ()=>{
        const name = prompt('Enter new user name');
        if(!name) return;
        const id = uid();
        state.users.push({id, name:name.trim(), active:true, isAdmin:false});
        save();
        renderUsersPage();
        populateUsers();
        populateFilterUsers();
      };
    }
    state.users.forEach(u=>{
      const tr = document.createElement('tr');
      const status = (u.active===false)? 'Inactive' : 'Active';
      const role = u.isAdmin? 'Admin' : 'User';
      const disableDemote = (u.isAdmin && state.users.filter(x=>x.isAdmin).length<=1);
      tr.innerHTML = `
        <td>${esc(u.name)}</td>
        <td>${role}</td>
        <td>${status}</td>
        <td class="right">
          <button class="btn" data-changepw="${u.id}">Change Password</button>
          <button class="btn" data-toggleactive="${u.id}">${u.active===false?'Activate':'Deactivate'}</button>
          <button class="btn" data-toggleadmin="${u.id}" ${disableDemote?'disabled':''}>${u.isAdmin?'Revoke Admin':'Make Admin'}</button>
          <button class="btn ghost" style="color:#b91c1c" data-deleteuser="${u.id}" ${u.isAdmin?'disabled':''}>Delete</button>
        </td>`;
      tbody.appendChild(tr);
    });

    // Bind actions
    $$('button[data-changepw]').forEach(btn=>btn.addEventListener('click', async ()=>{
      const uid = btn.getAttribute('data-changepw');
      await changeUserPassword(uid);
    }));
    $$('button[data-toggleactive]').forEach(btn=>btn.addEventListener('click', ()=>{
      const uid = btn.getAttribute('data-toggleactive');
      toggleUserActive(uid);
    }));
    $$('button[data-toggleadmin]').forEach(btn=>btn.addEventListener('click', ()=>{
      const uid = btn.getAttribute('data-toggleadmin');
      toggleUserAdmin(uid);
    }));
    $$('button[data-deleteuser]').forEach(btn=>btn.addEventListener('click', ()=>{
      const uid = btn.getAttribute('data-deleteuser');
      deleteUser(uid);
    }));
  }

  async function changeUserPassword(userId){
    const user = (state.users||[]).find(u=>u.id===userId);
    if(!user){ alert('User not found'); return; }
    if(user.isAdmin){
      const pw1 = prompt('Set new admin password'); if(!pw1){ return; }
      const pw2 = prompt('Confirm new admin password'); if(pw1!==pw2){ alert('Passwords do not match'); return; }
      const {salt, hash} = await hashPassword(pw1); state.adminAuth = {salt, hash}; save(); alert('Admin password updated.');
    } else {
      // For non-admins we currently do not use password on login, but we can store hashed for future
      const pw1 = prompt(`Set password for ${user.name}`); if(!pw1){ return; }
      const pw2 = prompt('Confirm password'); if(pw1!==pw2){ alert('Passwords do not match'); return; }
      const {salt, hash} = await hashPassword(pw1);
      user.pw = {salt, hash}; save(); alert('Password updated.');
    }
  }

  function toggleUserActive(userId){
    const user = (state.users||[]).find(u=>u.id===userId);
    if(!user){ return; }
    user.active = user.active===false ? true : false; save(); renderUsersPage(); populateUsers(); populateFilterUsers();
  }

  function toggleUserAdmin(userId){
    const user = (state.users||[]).find(u=>u.id===userId);
    if(!user){ return; }
    const totalAdmins = state.users.filter(u=>u.isAdmin).length;
    if(user.isAdmin && totalAdmins<=1){ alert('At least one admin is required.'); return; }
    user.isAdmin = !user.isAdmin; save(); renderUsersPage(); updateAdminUI(); populateUsers();
  }

  function deleteUser(userId){
    const me = (state.users||[]).find(u=>u.id===state.activeUserId);
    if(!me || !me.isAdmin){ alert('Only admin can delete users.'); return; }
    const user = (state.users||[]).find(u=>u.id===userId);
    if(!user){ return; }
    if(user.isAdmin){ alert('Cannot delete an admin user. Revoke admin first.'); return; }
    // Reassignment choice if the user has invoices
    const hasInvoices = Object.values(state.months||{}).some(m => (m.invoices||[]).some(inv => inv.addedBy===user.id));
    let reassignTo = null;
    if(hasInvoices){
      const candidates = state.users.filter(u=>u.id!==user.id).map(u=>u.name).join(', ');
      const msg = candidates? `Type the name of the user to reassign invoices to (${candidates}), or leave blank to keep invoices attributed to an inactive record.` : 'No other users found. Invoices will keep old attribution.';
      const targetName = prompt(msg, '');
      if(targetName){
        const target = state.users.find(u=>u.name===targetName);
        if(target) reassignTo = target.id;
      }
    }
    if(!confirm(`Delete user "${user.name}"?`)) return;
    // Soft delete or hard delete? You asked to delete, so we hard delete from list and handle invoices
    Object.values(state.months||{}).forEach(m=>{
      (m.invoices||[]).forEach(inv=>{ if(inv.addedBy===user.id){ if(reassignTo){ inv.addedBy=reassignTo; inv.addedByName=userName(reassignTo); } }});
    });
    state.users = state.users.filter(u=>u.id!==user.id);
    if(state.activeUserId===user.id){
      const firstActive = state.users.find(u=>u.active!==false) || state.users[0] || null;
      state.activeUserId = firstActive? firstActive.id : null;
    }
    save();
    renderUsersPage(); updateAdminUI(); populateUsers(); populateFilterUsers(); render();
  }

  // default dates on dashboard: current month
  const d0 = firstOfMonth(new Date(state.selectedYM+'-01T00:00:00'));
  $('#startDate').value = d0.toISOString().slice(0,10);
  $('#endDate').value = new Date(d0.getFullYear(), d0.getMonth()+1, 0).toISOString().slice(0,10);

  // initial renders
  render();
  renderSalesTable();
  renderCategory('liq');
})();
</script>
</body>
</html>
